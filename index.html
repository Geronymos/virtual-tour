<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <title>360&deg; Image Gallery</title>
  <meta name="description" content="360&deg; Image Gallery - A-Frame">
  <script src="https://aframe.io/releases/1.0.4/aframe.min.js"></script>
  <script src="https://unpkg.com/aframe-event-set-component@5/dist/aframe-event-set-component.min.js"></script>
  <!-- <script src="https://unpkg.com/aframe-layout-component@5.3.0/dist/aframe-layout-component.min.js"></script> -->
  <!-- <script src="https://unpkg.com/aframe-template-component@3.2.1/dist/aframe-template-component.min.js"></script> -->
  <!-- <script src="https://unpkg.com/aframe-proxy-event-component@2.1.0/dist/aframe-proxy-event-component.min.js"></script> -->
  <script src="https://unpkg.com/aframe-state-component@7.1.0/dist/aframe-state-component.min.js"></script>
  <script>
    const portal_map = [
      {
        from: "#cubes",
        to: "#city",
      },
      {
        from: "#city",
        to: "#sechelt",
      },
      {
        from: "#sechelt",
        to: "#cubes",
      }
    ];

    AFRAME.registerState({
      initialState: {
        image: "#cubes",
        links: portal_map.map((portal, index) => ({ ...portal, index, visible: false, href: portal.from, position: { x: index * 2, y: 0, z: -3 } }))
      },

      handlers: {
        changeRoom: function (state, action) {
          state.image = action.image;
          state.links.forEach(link => {
            const in_scene = [link.from, link.to].includes(action.image);
            link.visible = in_scene;
            link.href = in_scene && (link.from == action.image) ? link.to : link.from;
          });
          document.querySelector("#image-360").emit("fade");
          state.links.__dirty = true;
        }
      },
    });
  </script>
</head>

<body>
  <a-scene cursor="rayOrigin: mouse" raycaster="objects: .link">
    <a-assets>
      <img id="city" crossorigin="anonymous" src="https://cdn.aframe.io/360-image-gallery-boilerplate/img/city.jpg">
      <img id="city-thumb" crossorigin="anonymous"
        src="https://cdn.aframe.io/360-image-gallery-boilerplate/img/thumb-city.jpg">
      <img id="cubes-thumb" crossorigin="anonymous"
        src="https://cdn.aframe.io/360-image-gallery-boilerplate/img/thumb-cubes.jpg">
      <img id="sechelt-thumb" crossorigin="anonymous"
        src="https://cdn.aframe.io/360-image-gallery-boilerplate/img/thumb-sechelt.jpg">
      <audio id="click-sound" crossorigin="anonymous"
        src="https://cdn.aframe.io/360-image-gallery-boilerplate/audio/click.ogg"></audio>
      <img id="cubes" crossorigin="anonymous" src="https://cdn.aframe.io/360-image-gallery-boilerplate/img/cubes.jpg">
      <img id="sechelt" crossorigin="anonymous"
        src="https://cdn.aframe.io/360-image-gallery-boilerplate/img/sechelt.jpg">
    </a-assets>

    <!-- 360-degree image. -->
    <a-sky id="image-360" radius="10" src="#city" bind__src="image"
      animation__fadeback="property: components.material.material.color; type: color; from: #000; to: #FFF; dur: 300; startEvents: fade">
    </a-sky>
    <a-entity bind-for="for: item; in: links; key: index; updateInPlace: true">
      <template>
        <a-entity rotation="0 0 0" bind-item__position="item.position"> -->
          <a-link title="Door" class="link" bind-item__class="!item.visible || 'link'" bind-item__href="item.href" bind-item__image="item.href"
            bind-item__visible="item.visible">
          </a-link>
        </a-entity>
      </template>
    </a-entity>

    <!-- Camera + cursor. -->
    <a-entity camera look-controls>
      <a-cursor id="cursor"
        animation__click="property: scale; startEvents: click; from: 0.1 0.1 0.1; to: 1 1 1; dur: 150"
        animation__fusing="property: fusing; startEvents: fusing; from: 1 1 1; to: 0.1 0.1 0.1; dur: 1500"
        event-set__mouseenter="_event: mouseenter; color: springgreen"
        event-set__mouseleave="_event: mouseleave; color: black" raycaster="objects: .link"></a-cursor>
    </a-entity>
  </a-scene>

  <script>
    const sceneEl = document.querySelector('a-scene');

    // AFRAME.scenes[0].systems.state.dispatch('changeRoom', {image: location.hash});
    // AFRAME.scenes[0].emit('changeRoom', { image: location.hash });
    // AFRAME.scenes[0].systems.state.dispatch('changeRoom', {image: location.hash});
    sceneEl.emit('changeRoom', { image: location.hash });

    window.addEventListener("hashchange", function (e) {
      sceneEl.emit('changeRoom', { image: location.hash });
      console.log("hash changed");
    });

    const images = sceneEl.querySelectorAll('a-assets img[id]');
    if (![...images].some(elem => elem.id === location.hash)) {
      location.hash = images[0].id
    }
  </script>
</body>

</html>